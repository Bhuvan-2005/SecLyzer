#!/bin/bash
# SecLyzer Control Script
# Complete control interface for SecLyzer behavioral authentication system

# Don't exit on error - handle errors ourselves
set +e

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Configuration
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
INSTALL_DIR="/opt/seclyzer"
LOG_DIR="/var/log/seclyzer"
USE_SYSTEMD=false

# Auto-detect virtual environment
detect_venv() {
    local user_home="${HOME:-$(getent passwd "$USER" | cut -d: -f6)}"
    local paths=(
        "$VENV_PATH"
        "$user_home/.seclyzer-venv"
        "$user_home/.venv"
        "$user_home/venv"
        "$user_home/Documents/Projects/venv"
        "/opt/seclyzer/venv"
    )
    
    for p in "${paths[@]}"; do
        if [ -n "$p" ] && [ -f "$p/bin/activate" ]; then
            echo "$p"
            return 0
        fi
    done
    
    # Fallback - create one if needed
    echo "$user_home/.seclyzer-venv"
}

VENV_PATH=$(detect_venv)

# Verify venv exists
check_venv() {
    if [ ! -f "$VENV_PATH/bin/activate" ]; then
        echo -e "${RED}✗ Python virtual environment not found at: $VENV_PATH${NC}"
        echo ""
        echo "Please create one:"
        echo "  python3 -m venv ~/.seclyzer-venv"
        echo "  source ~/.seclyzer-venv/bin/activate"
        echo "  pip install redis polars influxdb-client scikit-learn numpy"
        exit 1
    fi
}

# Check if systemd services exist
if systemctl list-units --all 2>/dev/null | grep -q "seclyzer-"; then
    USE_SYSTEMD=true
fi

# Password verification function
verify_seclyzer_password() {
    local password_file="/etc/seclyzer/.password_hash"
    
    if [ ! -f "$password_file" ]; then
        return 0  # Allow if no password set
    fi
    
    local stored_hash=$(cat "$password_file")
    read -s -p "Enter SecLyzer password: " entered_password
    echo ""
    
    local entered_hash=$(echo -n "$entered_password" | sha256sum | cut -d' ' -f1)
    
    if [ "$entered_hash" == "$stored_hash" ]; then
        return 0
    else
        return 1
    fi
}

show_banner() {
    echo -e "${BLUE}"
    echo "╔════════════════════════════════════════════════════════╗"
    echo "║           SecLyzer Control Interface                   ║"
    echo "║    Behavioral Biometric Authentication System          ║"
    echo "╚════════════════════════════════════════════════════════╝"
    echo -e "${NC}"
}

show_status() {
    show_banner
    echo -e "${CYAN}System Status:${NC}"
    echo ""
    
    # Collectors
    echo "Rust Collectors:"
    if pgrep -f "keyboard_collector" > /dev/null; then
        echo -e "  ${GREEN}✓${NC} Keyboard Collector"
    else
        echo -e "  ${RED}✗${NC} Keyboard Collector"
    fi
    
    if pgrep -f "mouse_collector" > /dev/null; then
        echo -e "  ${GREEN}✓${NC} Mouse Collector"
    else
        echo -e "  ${RED}✗${NC} Mouse Collector"
    fi
    
    if pgrep -f "app_monitor" > /dev/null; then
        echo -e "  ${GREEN}✓${NC} App Monitor"
    else
        echo -e "  ${RED}✗${NC} App Monitor"
    fi
    
    echo ""
    echo "Python Extractors:"
    if pgrep -f "keystroke_extractor.py" > /dev/null; then
        echo -e "  ${GREEN}✓${NC} Keystroke Extractor"
    else
        echo -e "  ${RED}✗${NC} Keystroke Extractor"
    fi
    
    if pgrep -f "mouse_extractor.py" > /dev/null; then
        echo -e "  ${GREEN}✓${NC} Mouse Extractor"
    else
        echo -e "  ${RED}✗${NC} Mouse Extractor"
    fi
    
    if pgrep -f "app_tracker.py" > /dev/null; then
        echo -e "  ${GREEN}✓${NC} App Tracker"
    else
        echo -e "  ${RED}✗${NC} App Tracker"
    fi
    
    echo ""
    echo "Authentication Engine:"
    if pgrep -f "seclyzer_daemon.py" > /dev/null; then
        echo -e "  ${GREEN}✓${NC} Inference + Decision Engine"
    else
        echo -e "  ${RED}✗${NC} Inference + Decision Engine"
    fi
    
    echo ""
    echo "Databases:"
    if redis-cli ping > /dev/null 2>&1; then
        echo -e "  ${GREEN}✓${NC} Redis"
    else
        echo -e "  ${RED}✗${NC} Redis"
    fi
    
    if curl -s http://localhost:8086/ping > /dev/null 2>&1; then
        echo -e "  ${GREEN}✓${NC} InfluxDB"
    else
        echo -e "  ${RED}✗${NC} InfluxDB"
    fi
    
    echo ""
    echo "Developer Mode:"
    if [ -f "/tmp/.seclyzer_dev_mode" ]; then
        echo -e "  ${YELLOW}⚠ ACTIVE${NC} (authentication bypassed)"
    else
        echo -e "  ${GREEN}✓${NC} Disabled (normal operation)"
    fi
    
    echo ""
    
    # Check for trained models
    echo "Trained Models:"
    if ls "$PROJECT_ROOT/data/models/keystroke_rf_"*.pkl > /dev/null 2>&1; then
        echo -e "  ${GREEN}✓${NC} Keystroke Model"
    else
        echo -e "  ${RED}✗${NC} Keystroke Model (not trained)"
    fi
    
    if ls "$PROJECT_ROOT/data/models/mouse_svm_"*.pkl > /dev/null 2>&1; then
        echo -e "  ${GREEN}✓${NC} Mouse Model"
    else
        echo -e "  ${RED}✗${NC} Mouse Model (not trained)"
    fi
    
    if ls "$PROJECT_ROOT/data/models/app_markov_"*.json > /dev/null 2>&1; then
        echo -e "  ${GREEN}✓${NC} App Usage Model"
    else
        echo -e "  ${RED}✗${NC} App Usage Model (not trained)"
    fi
}

start_services() {
    echo -e "${GREEN}Starting SecLyzer...${NC}"
    echo ""
    
    # Start Redis if not running
    echo -n "Redis: "
    if redis-cli ping > /dev/null 2>&1; then
        echo -e "${GREEN}✓${NC} already running"
    else
        sudo systemctl start redis-server 2>/dev/null || sudo service redis-server start 2>/dev/null || true
        sleep 1
        if redis-cli ping > /dev/null 2>&1; then
            echo -e "${GREEN}✓${NC} started"
        else
            echo -e "${RED}✗${NC} failed to start"
        fi
    fi
    
    # Start InfluxDB if not running
    echo -n "InfluxDB: "
    if curl -s http://localhost:8086/ping > /dev/null 2>&1; then
        echo -e "${GREEN}✓${NC} already running"
    else
        sudo systemctl start influxdb 2>/dev/null || sudo service influxdb start 2>/dev/null || true
        sleep 2
        if curl -s http://localhost:8086/ping > /dev/null 2>&1; then
            echo -e "${GREEN}✓${NC} started"
        else
            echo -e "${YELLOW}⚠${NC} not available (optional)"
        fi
    fi
    
    echo ""
    
    # Start collectors - need sudo for keyboard/mouse
    echo "Starting collectors..."
    
    # Create log directory
    sudo mkdir -p "$LOG_DIR" 2>/dev/null || mkdir -p "$LOG_DIR" 2>/dev/null || true
    sudo chown -R "$USER:$USER" "$LOG_DIR" 2>/dev/null || true
    
    # Find collector binaries
    local kb_bin="" mouse_bin="" app_bin=""
    for dir in "$PROJECT_ROOT/collectors" "/opt/seclyzer/bin" "/usr/local/bin"; do
        [ -z "$kb_bin" ] && [ -x "$dir/keyboard_collector/target/release/keyboard_collector" ] && kb_bin="$dir/keyboard_collector/target/release/keyboard_collector"
        [ -z "$kb_bin" ] && [ -x "$dir/keyboard_collector" ] && kb_bin="$dir/keyboard_collector"
        [ -z "$mouse_bin" ] && [ -x "$dir/mouse_collector/target/release/mouse_collector" ] && mouse_bin="$dir/mouse_collector/target/release/mouse_collector"
        [ -z "$mouse_bin" ] && [ -x "$dir/mouse_collector" ] && mouse_bin="$dir/mouse_collector"
        [ -z "$app_bin" ] && [ -x "$dir/app_monitor/target/release/app_monitor" ] && app_bin="$dir/app_monitor/target/release/app_monitor"
        [ -z "$app_bin" ] && [ -x "$dir/app_monitor" ] && app_bin="$dir/app_monitor"
    done
    
    # Start keyboard collector (needs root)
    if pgrep -f "keyboard_collector" > /dev/null 2>&1; then
        echo -e "  ${YELLOW}⚠${NC} Keyboard collector already running"
    elif [ -n "$kb_bin" ]; then
        echo -n "  Starting keyboard collector... "
        sudo nohup "$kb_bin" > "$LOG_DIR/keyboard_collector.log" 2>&1 &
        sleep 1
        if pgrep -f "keyboard_collector" > /dev/null 2>&1; then
            echo -e "${GREEN}✓${NC}"
        else
            echo -e "${RED}✗${NC} (check $LOG_DIR/keyboard_collector.log)"
        fi
    else
        echo -e "  ${RED}✗${NC} Keyboard collector binary not found"
    fi
    
    # Start mouse collector (needs root)
    if pgrep -f "mouse_collector" > /dev/null 2>&1; then
        echo -e "  ${YELLOW}⚠${NC} Mouse collector already running"
    elif [ -n "$mouse_bin" ]; then
        echo -n "  Starting mouse collector... "
        sudo nohup "$mouse_bin" > "$LOG_DIR/mouse_collector.log" 2>&1 &
        sleep 1
        if pgrep -f "mouse_collector" > /dev/null 2>&1; then
            echo -e "${GREEN}✓${NC}"
        else
            echo -e "${RED}✗${NC} (check $LOG_DIR/mouse_collector.log)"
        fi
    else
        echo -e "  ${RED}✗${NC} Mouse collector binary not found"
    fi
    
    # Start app monitor (doesn't need root, needs DISPLAY)
    if [ -n "$DISPLAY" ]; then
        if pgrep -f "app_monitor" > /dev/null 2>&1; then
            echo -e "  ${YELLOW}⚠${NC} App monitor already running"
        elif [ -n "$app_bin" ]; then
            echo -n "  Starting app monitor... "
            nohup "$app_bin" > "$LOG_DIR/app_monitor.log" 2>&1 &
            sleep 1
            if pgrep -f "app_monitor" > /dev/null 2>&1; then
                echo -e "${GREEN}✓${NC}"
            else
                echo -e "${RED}✗${NC} (check $LOG_DIR/app_monitor.log)"
            fi
        else
            echo -e "  ${RED}✗${NC} App monitor binary not found"
        fi
    else
        echo -e "  ${YELLOW}⚠${NC} App monitor skipped (no DISPLAY)"
    fi
    
    echo ""
    
    # Now start extractors automatically
    echo "Starting feature extractors..."
    start_extractors_internal
    
    # Final status
    echo ""
    local collectors=0 extractors=0
    pgrep -f "keyboard_collector" > /dev/null && ((collectors++))
    pgrep -f "mouse_collector" > /dev/null && ((collectors++))
    pgrep -f "app_monitor" > /dev/null && ((collectors++))
    pgrep -f "keystroke_extractor.py" > /dev/null && ((extractors++))
    pgrep -f "mouse_extractor.py" > /dev/null && ((extractors++))
    pgrep -f "app_tracker.py" > /dev/null && ((extractors++))
    
    echo -e "${GREEN}✓${NC} SecLyzer started"
    echo "  Collectors: $collectors/3"
    echo "  Extractors: $extractors/3"
    echo ""
    echo "Next steps:"
    echo "  seclyzer status         # Check system status"
    echo "  seclyzer train --check  # Check if enough data for training"
    echo "  seclyzer credentials    # View InfluxDB web credentials"
}

# Internal function to start extractors (called by start_services)
start_extractors_internal() {
    # Check venv first
    check_venv
    
    # Activate venv
    source "$VENV_PATH/bin/activate"
    export PYTHONPATH="$PROJECT_ROOT:$PYTHONPATH"
    
    # Start keystroke extractor
    if ! pgrep -f "keystroke_extractor.py" > /dev/null; then
        echo -n "  Starting keystroke extractor... "
        nohup python3 "$PROJECT_ROOT/processing/extractors/keystroke_extractor.py" > "$LOG_DIR/keystroke_extractor.log" 2>&1 &
        sleep 1
        if pgrep -f "keystroke_extractor.py" > /dev/null; then
            echo -e "${GREEN}✓${NC}"
        else
            echo -e "${RED}✗${NC}"
        fi
    fi
    
    # Start mouse extractor
    if ! pgrep -f "mouse_extractor.py" > /dev/null; then
        echo -n "  Starting mouse extractor... "
        nohup python3 "$PROJECT_ROOT/processing/extractors/mouse_extractor.py" > "$LOG_DIR/mouse_extractor.log" 2>&1 &
        sleep 1
        if pgrep -f "mouse_extractor.py" > /dev/null; then
            echo -e "${GREEN}✓${NC}"
        else
            echo -e "${RED}✗${NC}"
        fi
    fi
    
    # Start app tracker
    if ! pgrep -f "app_tracker.py" > /dev/null; then
        echo -n "  Starting app tracker... "
        nohup python3 "$PROJECT_ROOT/processing/extractors/app_tracker.py" > "$LOG_DIR/app_tracker.log" 2>&1 &
        sleep 1
        if pgrep -f "app_tracker.py" > /dev/null; then
            echo -e "${GREEN}✓${NC}"
        else
            echo -e "${RED}✗${NC}"
        fi
    fi
}

start_extractors() {
    echo -e "${GREEN}Starting Feature Extractors...${NC}"
    echo ""
    
    # Check venv first
    check_venv
    
    # Create log directory with proper permissions
    sudo mkdir -p "$LOG_DIR" 2>/dev/null || mkdir -p "$LOG_DIR" 2>/dev/null || true
    sudo chown -R "$USER:$USER" "$LOG_DIR" 2>/dev/null || true
    
    # Activate venv once
    source "$VENV_PATH/bin/activate"
    export PYTHONPATH="$PROJECT_ROOT:$PYTHONPATH"
    
    # Check if already running
    if pgrep -f "keystroke_extractor.py" > /dev/null; then
        echo -e "${YELLOW}⚠${NC} Keystroke extractor already running"
    else
        echo -n "Starting keystroke extractor... "
        nohup python3 "$PROJECT_ROOT/processing/extractors/keystroke_extractor.py" > "$LOG_DIR/keystroke_extractor.log" 2>&1 &
        sleep 1
        if pgrep -f "keystroke_extractor.py" > /dev/null; then
            echo -e "${GREEN}✓${NC}"
        else
            echo -e "${RED}✗ Failed${NC}"
            echo "  Check: cat $LOG_DIR/keystroke_extractor.log"
        fi
    fi
    
    if pgrep -f "mouse_extractor.py" > /dev/null; then
        echo -e "${YELLOW}⚠${NC} Mouse extractor already running"
    else
        echo -n "Starting mouse extractor... "
        nohup python3 "$PROJECT_ROOT/processing/extractors/mouse_extractor.py" > "$LOG_DIR/mouse_extractor.log" 2>&1 &
        sleep 1
        if pgrep -f "mouse_extractor.py" > /dev/null; then
            echo -e "${GREEN}✓${NC}"
        else
            echo -e "${RED}✗ Failed${NC}"
            echo "  Check: cat $LOG_DIR/mouse_extractor.log"
        fi
    fi
    
    if pgrep -f "app_tracker.py" > /dev/null; then
        echo -e "${YELLOW}⚠${NC} App tracker already running"
    else
        echo -n "Starting app tracker... "
        nohup python3 "$PROJECT_ROOT/processing/extractors/app_tracker.py" > "$LOG_DIR/app_tracker.log" 2>&1 &
        sleep 1
        if pgrep -f "app_tracker.py" > /dev/null; then
            echo -e "${GREEN}✓${NC}"
        else
            echo -e "${RED}✗ Failed${NC}"
            echo "  Check: cat $LOG_DIR/app_tracker.log"
        fi
    fi
    
    echo ""
    # Final status check
    local running=0
    pgrep -f "keystroke_extractor.py" > /dev/null && ((running++))
    pgrep -f "mouse_extractor.py" > /dev/null && ((running++))
    pgrep -f "app_tracker.py" > /dev/null && ((running++))
    
    if [ $running -eq 3 ]; then
        echo -e "${GREEN}✓${NC} All feature extractors running"
    elif [ $running -gt 0 ]; then
        echo -e "${YELLOW}⚠${NC} $running/3 extractors running"
    else
        echo -e "${RED}✗${NC} No extractors running - check logs in $LOG_DIR"
    fi
}

stop_extractors() {
    echo -e "${YELLOW}Stopping Feature Extractors...${NC}"
    
    pkill -f "keystroke_extractor.py" 2>/dev/null && echo -e "${GREEN}✓${NC} Keystroke extractor stopped" || true
    pkill -f "mouse_extractor.py" 2>/dev/null && echo -e "${GREEN}✓${NC} Mouse extractor stopped" || true
    pkill -f "app_tracker.py" 2>/dev/null && echo -e "${GREEN}✓${NC} App tracker stopped" || true
    
    echo -e "${GREEN}✓${NC} Feature extractors stopped"
}

start_auth_engine() {
    local no_locking=false
    
    # Parse arguments
    shift 2>/dev/null || true  # Remove 'auth' from args
    while [[ $# -gt 0 ]]; do
        case $1 in
            --no-locking|--scores-only)
                no_locking=true
                shift
                ;;
            *)
                shift
                ;;
        esac
    done
    
    echo -e "${GREEN}Starting Authentication Engine...${NC}"
    echo ""
    
    # Check for trained models
    if ! ls "$PROJECT_ROOT/data/models/keystroke_rf_"*.pkl > /dev/null 2>&1; then
        echo -e "${RED}✗ No trained models found!${NC}"
        echo ""
        echo "Please train models first:"
        echo "  seclyzer train --all"
        exit 1
    fi
    
    if pgrep -f "seclyzer_daemon.py" > /dev/null; then
        echo -e "${YELLOW}⚠${NC} Authentication engine already running"
        return
    fi
    
    # Check venv first
    check_venv
    
    sudo mkdir -p "$LOG_DIR" 2>/dev/null || mkdir -p "$LOG_DIR" 2>/dev/null || true
    sudo chown -R "$USER:$USER" "$LOG_DIR" 2>/dev/null || true
    
    source "$VENV_PATH/bin/activate"
    export PYTHONPATH="$PROJECT_ROOT:$PYTHONPATH"
    
    local daemon_args=""
    if [ "$no_locking" = true ]; then
        daemon_args="--no-locking"
        echo -e "${YELLOW}⚠${NC} Locking disabled (scores only mode)"
    fi
    
    nohup python3 "$PROJECT_ROOT/daemon/seclyzer_daemon.py" $daemon_args > "$LOG_DIR/seclyzer_daemon.log" 2>&1 &
    
    sleep 2
    
    if pgrep -f "seclyzer_daemon.py" > /dev/null; then
        echo -e "${GREEN}✓${NC} Authentication engine started"
        if [ "$no_locking" = true ]; then
            echo "  Mode: Scores only (no screen locking)"
        else
            echo "  Mode: Full protection (with screen locking)"
        fi
        echo ""
        echo "View logs: tail -f $LOG_DIR/seclyzer_daemon.log"
    else
        echo -e "${RED}✗${NC} Failed to start authentication engine"
        echo "Check logs: cat $LOG_DIR/seclyzer_daemon.log"
    fi
}

stop_auth_engine() {
    echo -e "${YELLOW}Stopping Authentication Engine...${NC}"
    
    pkill -f "seclyzer_daemon.py" 2>/dev/null && echo -e "${GREEN}✓${NC} Authentication engine stopped" || echo "Not running"
}

train_models() {
    echo -e "${CYAN}╔════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║           SecLyzer Model Training                      ║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    source "$VENV_PATH/bin/activate"
    export PYTHONPATH="$PROJECT_ROOT:$PYTHONPATH"
    
    # Parse arguments
    local train_all=false
    local train_keystroke=false
    local train_mouse=false
    local train_app=false
    local check_only=false
    local force=false
    local days=30
    
    shift  # Remove 'train' from args
    
    while [[ $# -gt 0 ]]; do
        case $1 in
            --all|-a)
                train_all=true
                shift
                ;;
            --keystroke|-k)
                train_keystroke=true
                shift
                ;;
            --mouse|-m)
                train_mouse=true
                shift
                ;;
            --app|-p)
                train_app=true
                shift
                ;;
            --check|-c)
                check_only=true
                shift
                ;;
            --force|-f)
                force=true
                shift
                ;;
            --days|-d)
                days="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done
    
    # Build command
    local cmd="python3 $PROJECT_ROOT/scripts/train_models.py"
    
    if [ "$check_only" = true ]; then
        cmd="$cmd --check"
    elif [ "$train_all" = true ]; then
        cmd="$cmd --all"
    else
        [ "$train_keystroke" = true ] && cmd="$cmd --keystroke"
        [ "$train_mouse" = true ] && cmd="$cmd --mouse"
        [ "$train_app" = true ] && cmd="$cmd --app"
    fi
    
    [ "$force" = true ] && cmd="$cmd --force"
    cmd="$cmd --days $days"
    
    # If no specific model selected and not check, default to all
    if [ "$train_all" = false ] && [ "$train_keystroke" = false ] && [ "$train_mouse" = false ] && [ "$train_app" = false ] && [ "$check_only" = false ]; then
        cmd="$cmd --all"
    fi
    
    echo "Running: $cmd"
    echo ""
    
    eval $cmd
    
    local exit_code=$?
    
    if [ $exit_code -eq 0 ] && [ "$check_only" = false ]; then
        echo ""
        echo -e "${GREEN}✓${NC} Training complete!"
        echo ""
        echo "Next steps:"
        echo "  seclyzer auth    # Start authentication engine with new models"
    fi
    
    return $exit_code
}

check_training_data() {
    echo -e "${CYAN}Checking Training Data Availability...${NC}"
    echo ""
    
    source "$VENV_PATH/bin/activate"
    export PYTHONPATH="$PROJECT_ROOT:$PYTHONPATH"
    
    python3 "$PROJECT_ROOT/scripts/train_models.py" --check
}

disable_authentication() {
    echo -e "${YELLOW}Disabling SecLyzer Authentication...${NC}"
    echo ""
    
    if ! verify_seclyzer_password; then
        echo -e "${RED}✗ Incorrect password. Access denied.${NC}"
        exit 1
    fi
    
    touch /tmp/.seclyzer_dev_mode
    
    echo -e "${GREEN}✓${NC} Authentication disabled (developer mode active)"
    echo ""
    echo "Data collection continues. To re-enable: seclyzer enable"
}

enable_authentication() {
    echo -e "${GREEN}Enabling SecLyzer Authentication...${NC}"
    
    rm -f /tmp/.seclyzer_dev_mode
    
    echo -e "${GREEN}✓${NC} Authentication enabled"
}

stop_all() {
    echo -e "${RED}╔═══════════════════════════════════════════════════╗${NC}"
    echo -e "${RED}║  WARNING: This will STOP all SecLyzer services!  ║${NC}"
    echo -e "${RED}╚═══════════════════════════════════════════════════╝${NC}"
    echo ""
    
    if ! verify_seclyzer_password; then
        echo -e "${RED}✗ Incorrect password. Access denied.${NC}"
        exit 1
    fi
    
    read -p "Are you sure? [y/N]: " confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        echo "Cancelled."
        exit 0
    fi
    
    echo ""
    echo "Stopping all services..."
    
    # Stop auth engine
    pkill -f "seclyzer_daemon.py" 2>/dev/null || true
    echo -e "${GREEN}✓${NC} Authentication engine stopped"
    
    # Stop extractors
    pkill -f "keystroke_extractor.py" 2>/dev/null || true
    pkill -f "mouse_extractor.py" 2>/dev/null || true
    pkill -f "app_tracker.py" 2>/dev/null || true
    echo -e "${GREEN}✓${NC} Feature extractors stopped"
    
    # Stop collectors
    pkill -f "keyboard_collector" 2>/dev/null || true
    pkill -f "mouse_collector" 2>/dev/null || true
    pkill -f "app_monitor" 2>/dev/null || true
    echo -e "${GREEN}✓${NC} Collectors stopped"
    
    echo ""
    echo -e "${GREEN}✓${NC} All SecLyzer services stopped"
}

restart_services() {
    echo -e "${YELLOW}Restarting SecLyzer services...${NC}"
    echo ""
    
    # Stop everything first
    pkill -f "seclyzer_daemon.py" 2>/dev/null || true
    pkill -f "keystroke_extractor.py" 2>/dev/null || true
    pkill -f "mouse_extractor.py" 2>/dev/null || true
    pkill -f "app_tracker.py" 2>/dev/null || true
    pkill -f "keyboard_collector" 2>/dev/null || true
    pkill -f "mouse_collector" 2>/dev/null || true
    pkill -f "app_monitor" 2>/dev/null || true
    
    sleep 2
    
    # Start services
    start_services
    start_extractors
    
    # Start auth if models exist
    if ls "$PROJECT_ROOT/data/models/keystroke_rf_"*.pkl > /dev/null 2>&1; then
        start_auth_engine
    fi
    
    echo ""
    echo -e "${GREEN}✓${NC} SecLyzer restarted"
}

show_logs() {
    local component="${1:-all}"
    
    echo -e "${CYAN}SecLyzer Logs${NC}"
    echo -e "${YELLOW}Press Ctrl+C to stop${NC}"
    echo ""
    
    case "$component" in
        auth|daemon)
            tail -f "$LOG_DIR/seclyzer_daemon.log" 2>/dev/null || echo "No auth logs found"
            ;;
        keystroke)
            tail -f "$LOG_DIR/keystroke_extractor.log" 2>/dev/null || echo "No keystroke logs found"
            ;;
        mouse)
            tail -f "$LOG_DIR/mouse_extractor.log" 2>/dev/null || echo "No mouse logs found"
            ;;
        app)
            tail -f "$LOG_DIR/app_tracker.log" 2>/dev/null || echo "No app logs found"
            ;;
        all|*)
            tail -f "$LOG_DIR"/*.log 2>/dev/null || echo "No logs found in $LOG_DIR"
            ;;
    esac
}

reload_models() {
    echo -e "${CYAN}Reloading models...${NC}"
    
    if ! pgrep -f "seclyzer_daemon.py" > /dev/null; then
        echo -e "${RED}✗${NC} Authentication engine not running"
        exit 1
    fi
    
    # Send SIGHUP to reload models
    pkill -HUP -f "seclyzer_daemon.py" 2>/dev/null
    
    echo -e "${GREEN}✓${NC} Model reload signal sent"
    echo "Check logs: tail -f $LOG_DIR/seclyzer_daemon.log"
}

show_version() {
    echo -e "${BLUE}SecLyzer v0.3.1${NC}"
    echo "Behavioral Biometric Authentication System"
    echo ""
    echo "Phase 4: Decoupled Engine Architecture"
    echo ""
    echo "Components:"
    echo "  • Rust Collectors (keyboard, mouse, app)"
    echo "  • Python Feature Extractors"
    echo "  • ML Models (Random Forest, One-Class SVM, Markov Chain)"
    echo "  • Inference Engine (real-time scoring)"
    echo "  • Decision Engine (authentication state machine)"
    echo "  • Locking Engine (system actions - optional)"
}

show_credentials() {
    echo -e "${CYAN}╔════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║           SecLyzer Database Credentials                ║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════════════════════╝${NC}"
    echo ""
    
    # Verify password first
    if ! verify_seclyzer_password; then
        echo -e "${RED}✗ Incorrect password. Access denied.${NC}"
        exit 1
    fi
    
    echo ""
    
    # InfluxDB credentials
    echo -e "${BLUE}InfluxDB Web Interface:${NC}"
    echo "  URL: http://localhost:8086"
    echo ""
    
    local cred_file="/etc/seclyzer/.credentials"
    local token_file="/etc/seclyzer/influxdb_token"
    
    if [ -f "$cred_file" ]; then
        echo "  Username: seclyzer_admin"
        local influx_pass=$(grep "INFLUX_PASSWORD=" "$cred_file" 2>/dev/null | cut -d'=' -f2)
        if [ -n "$influx_pass" ]; then
            echo "  Password: $influx_pass"
        else
            echo "  Password: (not found in credentials file)"
        fi
    else
        echo "  Username: seclyzer_admin"
        echo "  Password: (credentials file not found at $cred_file)"
    fi
    
    echo ""
    
    if [ -f "$token_file" ]; then
        echo "  API Token: $(cat "$token_file")"
    else
        echo "  API Token: (not found at $token_file)"
    fi
    
    echo ""
    echo -e "${BLUE}Organization:${NC} seclyzer"
    echo -e "${BLUE}Bucket:${NC} behavioral_data"
    echo ""
    
    # Redis info
    echo -e "${BLUE}Redis:${NC}"
    echo "  Host: localhost"
    echo "  Port: 6379"
    echo "  (No authentication by default)"
    echo ""
    
    # Check if services are running
    echo -e "${BLUE}Service Status:${NC}"
    if curl -s http://localhost:8086/ping > /dev/null 2>&1; then
        echo -e "  InfluxDB: ${GREEN}Running${NC}"
    else
        echo -e "  InfluxDB: ${RED}Not running${NC}"
    fi
    
    if redis-cli ping > /dev/null 2>&1; then
        echo -e "  Redis: ${GREEN}Running${NC}"
    else
        echo -e "  Redis: ${RED}Not running${NC}"
    fi
}

show_resources() {
    echo -e "${BLUE}╔═══════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║      SecLyzer Resource Usage                      ║${NC}"
    echo -e "${BLUE}╚═══════════════════════════════════════════════════╝${NC}"
    echo ""

    printf "%-25s %-8s %-8s %-8s\n" "COMPONENT" "PID" "CPU%" "MEM(MB)"
    echo "-----------------------------------------------------"

    print_proc_stats() {
        local name=$1
        local pattern=$2
        local stats=$(ps -eo pid,pcpu,rss,cmd | grep "$pattern" | grep -v "grep" | head -n 1)
        
        if [ -n "$stats" ]; then
            local pid=$(echo "$stats" | awk '{print $1}')
            local cpu=$(echo "$stats" | awk '{print $2}')
            local rss_kb=$(echo "$stats" | awk '{print $3}')
            local mem_mb=$(echo "scale=1; $rss_kb / 1024" | bc 2>/dev/null || echo "0")
            printf "%-25s %-8s %-8s %-8s\n" "$name" "$pid" "$cpu%" "${mem_mb}MB"
        else
            printf "%-25s %-8s %-8s %-8s\n" "$name" "-" "-" "-"
        fi
    }

    print_proc_stats "Keyboard Collector" "keyboard_collector"
    print_proc_stats "Mouse Collector" "mouse_collector"
    print_proc_stats "App Monitor" "app_monitor"
    echo "-----------------------------------------------------"
    print_proc_stats "Keystroke Extractor" "keystroke_extractor.py"
    print_proc_stats "Mouse Extractor" "mouse_extractor.py"
    print_proc_stats "App Tracker" "app_tracker.py"
    echo "-----------------------------------------------------"
    print_proc_stats "Auth Engine" "seclyzer_daemon.py"
    echo "-----------------------------------------------------"
    print_proc_stats "Redis" "redis-server"
    print_proc_stats "InfluxDB" "influxd"
    echo ""
}

show_help() {
    show_banner
    echo "Usage: seclyzer <command> [options]"
    echo ""
    echo -e "${CYAN}SERVICE MANAGEMENT:${NC}"
    echo "  start           Start databases, collectors, and extractors"
    echo "  stop-all        Stop ALL SecLyzer services"
    echo "  restart         Restart all services"
    echo "  status          Show status of all components"
    echo "  resources       Show resource usage"
    echo ""
    echo -e "${CYAN}MODEL TRAINING:${NC}"
    echo "  train --all         Train all models (keystroke, mouse, app)"
    echo "  train --keystroke   Train keystroke model only"
    echo "  train --mouse       Train mouse model only"
    echo "  train --app         Train app usage model only"
    echo "  train --check       Check training data availability"
    echo "  train --force       Force training even with insufficient data"
    echo "  train --days N      Use N days of historical data (default: 30)"
    echo ""
    echo -e "${CYAN}AUTHENTICATION CONTROL:${NC}"
    echo "  auth                Start authentication (inference + decision + locking)"
    echo "  auth --no-locking   Start without locking (scores only, for debugging)"
    echo "  stop-auth           Stop authentication engine"
    echo "  disable             Disable authentication (developer mode)"
    echo "  enable              Re-enable authentication"
    echo "  reload              Hot-reload trained models"
    echo ""
    echo -e "${CYAN}MONITORING & INFO:${NC}"
    echo "  logs [component]    View logs (all, auth, keystroke, mouse, app)"
    echo "  credentials         Show InfluxDB web interface credentials"
    echo "  version             Show version information"
    echo ""
    echo -e "${CYAN}EXAMPLES:${NC}"
    echo "  seclyzer start              # Start all data collection"
    echo "  seclyzer train --check      # Check if enough data for training"
    echo "  seclyzer train --all        # Train all models"
    echo "  seclyzer auth               # Start authentication"
    echo "  seclyzer status             # Check system status"
    echo "  seclyzer credentials        # View database credentials"
    echo "  seclyzer logs auth          # View authentication logs"
    echo ""
    echo -e "${CYAN}TYPICAL WORKFLOW:${NC}"
    echo "  1. seclyzer start           # Start data collection + extraction"
    echo "  2. (wait 1-2 weeks for data collection)"
    echo "  3. seclyzer train --all     # Train models"
    echo "  4. seclyzer auth            # Enable authentication"
}

# Main logic
case "${1:-}" in
    start)
        start_services
        ;;
    extractors)
        # Keep for backward compatibility, but start does this now
        start_extractors
        ;;
    auth)
        start_auth_engine "$@"
        ;;
    restart)
        restart_services
        ;;
    stop-extractors)
        stop_extractors
        ;;
    stop-auth)
        stop_auth_engine
        ;;
    stop-all)
        stop_all
        ;;
    status)
        show_status
        ;;
    resources)
        show_resources
        ;;
    logs)
        show_logs "${2:-all}"
        ;;
    train)
        train_models "$@"
        ;;
    check-data)
        check_training_data
        ;;
    credentials|creds)
        show_credentials
        ;;
    disable)
        disable_authentication
        ;;
    enable)
        enable_authentication
        ;;
    reload)
        reload_models
        ;;
    version|--version|-v)
        show_version
        ;;
    help|--help|-h)
        show_help
        ;;
    "")
        show_help
        ;;
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
